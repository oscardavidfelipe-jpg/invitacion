<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin - Invitaciones</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
body{font-family:Inter,Arial;background:#f4f3f1;color:#222;margin:0;padding:30px}
.container{max-width:1100px;margin:auto}
.card{background:white;padding:20px;border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,0.06)}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
.inputpass{padding:10px;border-radius:8px;border:1px solid #ddd;width:260px}
.btn{background:#b7955a;color:white;padding:10px 14px;border:none;border-radius:8px;cursor:pointer}
.btn.danger{background:#b34747}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
.small{font-size:13px;color:#666}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>Panel Admin</h1>
    <p class="small">Accedé con la contraseña para ver y descargar los listados en PDF.</p>

    <div style="margin-top:8px">
      <input id="pwd" class="inputpass" type="password" placeholder="Contraseña admin"/>
      <button class="btn" onclick="login()">Entrar</button>
    </div>

    <div id="panel" style="display:none;margin-top:14px">
      <div class="controls">
        <button class="btn" onclick="loadLocal()">Cargar local</button>
        <button class="btn" onclick="exportCSV()">Exportar CSV</button>
        <button class="btn" onclick="generateAllPDFs()">Generar PDFs (Asist., Restric., Música)</button>
        <button class="btn danger" onclick="clearAll()">Borrar todo (local)</button>
      </div>

      <div id="stats" class="small"></div>

      <table id="tbl"><thead><tr><th>Nombre</th><th>Email</th><th>Asiste</th><th>Acomp.</th><th>Restricciones</th><th>Música</th><th>Fecha</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<!-- libraries: jsPDF and html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
const ADMIN_PASS = "pabloAdmin2025";
const KEY = 'invitaciones_pablo_asist';

function login(){
  if(document.getElementById('pwd').value === ADMIN_PASS){
    document.getElementById('panel').style.display='block';
    loadLocal();
  } else {
    alert('Contraseña incorrecta');
  }
}

function loadLocal(){
  const arr = JSON.parse(localStorage.getItem(KEY)||'[]');
  render(arr);
  updateStats(arr);
}

function render(arr){
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = '';
  arr.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.nombre}</td><td>${r.email}</td><td>${r.asiste}</td><td>${r.acompanantes}</td><td>${r.restricciones}</td><td>${r.musica}</td><td>${new Date(r.ts).toLocaleString()}</td>`;
    tbody.appendChild(tr);
  });
}

function updateStats(arr){
  document.getElementById('stats').textContent = `Registros: ${arr.length} — Confirmados: ${arr.filter(x=>x.asiste==='Sí').length}`;
}

function exportCSV(){
  const arr = JSON.parse(localStorage.getItem(KEY)||'[]');
  let csv = 'nombre,email,asiste,acompanantes,restricciones,musica,ts\n';
  arr.forEach(r=> csv += `"${r.nombre}","${r.email}","${r.asiste}","${r.acompanantes}","${r.restricciones}","${r.musica}","${r.ts}"\n`);
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'asistencias_pablo.csv';
  a.click();
}

function clearAll(){
  if(!confirm('Borrar todos los registros locales?')) return;
  localStorage.removeItem(KEY);
  render([]);
  updateStats([]);
}

// PDF helpers
async function generatePDF(title, rows, columns){
  // create a temporary table
  const tbl = document.createElement('div');
  tbl.style.padding = '20px';
  tbl.style.fontFamily = 'Arial';
  let html = `<h2 style="color:#b7955a">${title}</h2><table style="width:100%;border-collapse:collapse">`;
  html += '<thead><tr>';
  columns.forEach(c=> html += `<th style="border-bottom:1px solid #ddd;padding:8px;text-align:left">${c}</th>`);
  html += '</tr></thead><tbody>';
  rows.forEach(r=>{
    html += '<tr>';
    columns.forEach(col=> html += `<td style="padding:6px;border-bottom:1px solid #f0f0f0">${r[col.toLowerCase()]||''}</td>`);
    html += '</tr>';
  });
  html += '</tbody></table>';
  tbl.innerHTML = html;
  document.body.appendChild(tbl);
  // render to canvas then to pdf
  const canvas = await html2canvas(tbl, {scale:2});
  const img = canvas.toDataURL('image/jpeg', 0.95);
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','mm','a4');
  const imgProps = pdf.getImageProperties(img);
  const pdfWidth = pdf.internal.pageSize.getWidth() - 20;
  const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
  pdf.addImage(img, 'JPEG', 10, 10, pdfWidth, pdfHeight);
  const filename = title.toLowerCase().replace(/\s+/g,'_') + '.pdf';
  pdf.save(filename);
  document.body.removeChild(tbl);
}

function generateAllPDFs(){
  const arr = JSON.parse(localStorage.getItem(KEY)||'[]');
  if(arr.length === 0){ alert('No hay registros para exportar'); return; }
  // asistencias: all columns
  const rows = arr.map(a=> ({nombre:a.nombre,email:a.email,asiste:a.asiste,acompanantes:a.acompanantes,restricciones:a.restricciones,musica:a.musica,ts:new Date(a.ts).toLocaleString()}));
  generatePDF('Listado de asistencias', rows, ['Nombre','Email','Asiste','Acompanantes','Restricciones','Musica','Ts']);
  // restricciones
  const restr = arr.map(a=> ({nombre:a.nombre,restricciones:a.restricciones}));
  generatePDF('Restricciones alimentarias', restr, ['Nombre','Restricciones']);
  // musica
  const mus = arr.map(a=> ({nombre:a.nombre,musica:a.musica}));
  generatePDF('Sugerencias musicales', mus, ['Nombre','Musica']);
}

</script>
</body>
</html>
